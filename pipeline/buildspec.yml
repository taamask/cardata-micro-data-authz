version: 0.2
proxy:
  upload-artifacts: no
  logs: no
phases:
  install:
    runtime-versions:
      golang: 1.20
    commands:
      - aws ecr get-login-password | docker login --username AWS --password-stdin $AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com
  pre_build:
    commands:
      - echo Pre-Build Phase `date`
      - SHORTHASH=$(echo $CODEBUILD_RESOLVED_SOURCE_VERSION | head -c8)
      - VERSION="${RELEASE}-SNAPSHOT.${SHORTHASH}"
      - echo version $VERSION
      - aws cloudformation validate-template --template-body file://cloudformation/cloudformation.yml
  build:
    commands:
      - echo Build Phase `date`
      - docker build -t $REPO_NAME:$VERSION .
  post_build:
    commands:
      - echo Post-Build Phase `date`
      - docker tag $REPO_NAME:$VERSION $REPO_URL/$REPO_NAME:$VERSION
      - docker tag $REPO_NAME:$VERSION $REPO_URL/$REPO_NAME:latest
      - docker push $REPO_URL/$REPO_NAME --all-tags
      - printf '{"Version":"%s"}' $VERSION > Overrides.json
artifacts:
  files:
    - Overrides.json
    - cloudformation/*
  discard-paths: yes