schema: |-
  definition fvh/user {
  	relation partner: fvh/partner
  }

  definition fvh/organization_fqdn {}

  caveat is_in_organization_fqdn(organization_fqdn string, user_fqdn string) {
  	user_fqdn == organization_fqdn
  }

  definition fvh/organization_role {
      relation role_organization: fvh/organization
      relation member: fvh/user
  }

  definition fvh/organization {
  	relation platform_admin: fvh/organization_role#member with is_in_organization_fqdn
  	relation platform_support: fvh/organization_role#member
  	relation account_manager: fvh/organization_role#member

  	permission can_create_platform_user = platform_admin
  	permission can_create_partner = platform_admin + account_manager

  	permission can_assign_role_account_manager = platform_admin
  	permission can_assign_role_platform_admin = platform_admin
  	permission can_assign_role_platform_support = platform_admin

  	permission can_revoke_role_account_manager = platform_admin
  	permission can_revoke_role_platform_admin = platform_admin
  	permission can_revoke_role_platform_support = platform_admin

  	//ToDo: account manager to be added to performance (only associated with the actual partner)
  	permission can_view_performance = platform_admin

  	//permission can_create_product = platform_admin
  }

  definition fvh/partner {
  	relation parent_organization: fvh/organization
  	relation partner_user: fvh/user
  	relation partner_admin: fvh/user
  	relation api_key_manager: fvh/user
  	relation dashboard_user: fvh/user


  	//Technical/calculated relations
      permission account_manager = (parent_organization->account_manager & partner_user)
  	permission partner_manager = partner_admin + account_manager + parent_organization->platform_admin
  	permission all_partner_user = partner_user + partner_manager
  	
  	// synthetic relation
  	permission synthetic_relation_platform_admin = parent_organization->platform_admin
  	permission synthetic_relation_platform_support = parent_organization->platform_support

  	permission can_test = api_key_manager & partner_user

  	//User who can access that specific partner instance
  	permission can_view_partner = parent_organization->platform_support + partner_manager + partner_user

  	//User management
  	permission can_create_partner_user = synthetic_relation_platform_admin + parent_organization->platform_support + partner_admin + account_manager
  	permission can_manage_user = synthetic_relation_platform_admin + parent_organization->platform_support + partner_admin
  	permission can_deassociate_user_from_partner = synthetic_relation_platform_admin + partner_admin

  	//Partner management
  	permission can_edit_partner_metadata = partner_manager
  	permission can_associate_subscription = synthetic_relation_platform_admin + account_manager
  	permission can_manage_subscription = synthetic_relation_platform_admin + account_manager
  	permission can_view_subscription = partner_manager

  	//Role assignment
  	permission can_assign_role_partner_admin = partner_manager
  	permission can_assign_role_partner_api_manager = partner_manager

  	//Role revoke
  	permission can_revoke_role_partner_admin = synthetic_relation_platform_admin + account_manager
  	permission can_revoke_role_partner_api_manager = synthetic_relation_platform_admin + partner_admin

  	//Subfleet and vehicle management
  	permission can_create_subfleet = synthetic_relation_platform_admin + partner_admin
  	permission can_edit_subfleet_metadata = synthetic_relation_platform_admin + partner_admin
  	permission can_list_all_subfleets = synthetic_relation_platform_admin + parent_organization->platform_support + partner_admin
  	permission can_manage_vehicle_request = synthetic_relation_platform_admin + partner_admin
  	permission can_list_all_vehicle_request = synthetic_relation_platform_admin + parent_organization->platform_support + partner_admin
  	permission can_remove_subfleet = synthetic_relation_platform_admin + partner_admin
  	permission can_deassociate_user_from_subfleet = synthetic_relation_platform_admin + partner_admin
  	permission can_deassociate_vehicle_from_subfleet = synthetic_relation_platform_admin + partner_admin
  	permission can_remove_vehicle = synthetic_relation_platform_admin + partner_admin
  	permission can_list_all_subfleet = partner_manager
  	permission approve_vehicle = synthetic_relation_platform_admin  + partner_admin

  	//Includes associating vehicles to subfleets / create vehicle
  	permission can_create_vehicle = synthetic_relation_platform_admin + partner_admin
  	permission can_associate_user_to_subfleet = synthetic_relation_platform_admin + partner_admin

  	//Headless api management !!!WATCH OUT BOTH THESE PERMISSIONS AND THE RELEVANT SUBSCRIPTION NEED TO BE CHECKED!!!
  	permission can_generate_api_key = synthetic_relation_platform_admin + api_key_manager + partner_admin 
  	permission can_list_all_api_key = synthetic_relation_platform_admin + api_key_manager + partner_admin
  	permission can_remove_api_key = synthetic_relation_platform_admin + api_key_manager + partner_admin

  	// subscription management
  	permission manage_subscription = account_manager + synthetic_relation_platform_admin
  	permission view_subscription = partner_manager
  	permission can_revoke_subscription = synthetic_relation_platform_admin + account_manager
  }

  definition fvh/subfleet {
  	relation owner: fvh/partner
  	relation parent_subfleet: fvh/subfleet
  	relation subfleet_member: fvh/user

  	permission synthetic_relation_platform_admin = owner->synthetic_relation_platform_admin
  	permission synthetic_relation_partner_admin = owner->partner_admin
  	permission synthetic_relation_platform_support = owner->synthetic_relation_platform_support
  	permission synthetic_relation_subfleet_member = (subfleet_member + parent_subfleet->synthetic_relation_subfleet_member) & owner->partner_user
  	
  	//To be reviewed
  	permission can_create_vehicle_deassociation_request = synthetic_relation_platform_admin + synthetic_relation_partner_admin + synthetic_relation_subfleet_member
  	permission can_remove_note = synthetic_relation_platform_admin + synthetic_relation_partner_admin + synthetic_relation_subfleet_member
  	permission can_create_vehicle_request = synthetic_relation_platform_admin + synthetic_relation_partner_admin + synthetic_relation_subfleet_member
  	permission can_view_subfleet = synthetic_relation_platform_admin + synthetic_relation_partner_admin + synthetic_relation_subfleet_member
  	permission can_order_and_manage_dongle = synthetic_relation_platform_admin + synthetic_relation_partner_admin + synthetic_relation_subfleet_member
  	//To be reviewed with business
  	permission can_connect_to_oem = synthetic_relation_platform_admin + synthetic_relation_partner_admin + synthetic_relation_subfleet_member
  	permission can_create_note = synthetic_relation_platform_admin + synthetic_relation_partner_admin + synthetic_relation_subfleet_member
  }

  //The following definitions are serving the purpose to check whether a specific endpoint can be called with the user's partner's purchased product
  definition fvh/subscription {
  	relation subscriber: fvh/partner

  	permission synthetic_relation_partner_user = subscriber->partner_user
  }

  definition fvh/product {
  	relation parent_organization: fvh/organization
  	relation associated_subscription: fvh/subscription
  	//relation api_controller_method: api_controller_method

  	permission synthetic_relation_partner_user = associated_subscription->synthetic_relation_partner_user
  	permission can_access = synthetic_relation_partner_user + parent_organization->platform_admin + parent_organization->account_manager
  }

  // // ToDo: create a convention e.g.: {service-name}-{env}-{controller-class}-{method} dip-micro-b2b-backstage-qa-develop-/api/b2b/vehicle
  // definition api_controller_method {}
relationships: |-
  // set up organization roles
  fvh/organization_role:platform_admin#role_organization@fvh/organization:thebb
  fvh/organization_role:account_manager#role_organization@fvh/organization:thebb
  fvh/organization_role:platform_support#role_organization@fvh/organization:thebb

  // set up organization's role relations
  fvh/organization:thebb#platform_admin@fvh/organization_role:platform_admin#member[is_in_organization_fqdn:{"organization_fqdn":"thebb.com"}]
  fvh/organization:thebb#account_manager@fvh/organization_role:account_manager#member
  fvh/organization:thebb#platform_support@fvh/organization_role:platform_support#member

  // set up the organization's platform admins
  fvh/organization_role:platform_admin#member@fvh/user:tomi

  // set up the organization's account managers
  fvh/organization_role:account_manager#member@fvh/user:ben
  fvh/organization_role:account_manager#member@fvh/user:claire

  // set up partners
  fvh/partner:dhl#parent_organization@fvh/organization:thebb
  fvh/partner:wizz#parent_organization@fvh/organization:thebb

  // assign account managers to their partners
  fvh/partner:dhl#partner_user@fvh/user:ben
  fvh/partner:wizz#partner_user@fvh/user:claire

  // set up partner users
  fvh/partner:dhl#partner_user@fvh/user:marika
  fvh/partner:dhl#partner_user@fvh/user:feri
  fvh/partner:dhl#partner_user@fvh/user:mate
  fvh/partner:dhl#partner_user@fvh/user:bela
  fvh/partner:dhl#partner_user@fvh/user:neo
  fvh/partner:fedex#partner_user@fvh/user:adi

  // assign partner admin role to users
  fvh/partner:dhl#partner_admin@fvh/user:feri

  // assign api key manager role to users
  fvh/partner:dhl#api_key_manager@fvh/user:mate

  // set up subfleets
  fvh/subfleet:budapest_south#owner@fvh/partner:dhl
  fvh/subfleet:siofok#owner@fvh/partner:dhl
  fvh/subfleet:kispest#owner@fvh/partner:dhl
  fvh/subfleet:kispest#parent_subfleet@fvh/subfleet:budapest_south

  // add members to subfleets
  fvh/subfleet:budapest_south#subfleet_member@fvh/user:bela
  fvh/subfleet:kispest#subfleet_member@fvh/user:neo

  // set up products
  fvh/product:dashboard#parent_organization@fvh/organization:thebb
  fvh/product:headless_api#parent_organization@fvh/organization:thebb

  // set up partner subscriptions
  fvh/subscription:sub1263155181#subscriber@fvh/partner:dhl
  fvh/subscription:sub993155181#subscriber@fvh/partner:fedex

  // assign subscriptions to products
  fvh/product:dashboard#associated_subscription@fvh/subscription:sub1263155181
  fvh/product:headless_api#associated_subscription@fvh/subscription:sub993155181
assertions:
  assertTrue:
    - fvh/organization:thebb#can_create_platform_user@fvh/user:tomi with {"user_fqdn":"thebb.com"}
    - fvh/organization:thebb#can_create_platform_user@fvh/user:tomi with {"user_fqdn":"thebb.com"}
    - fvh/organization:thebb#can_create_partner@fvh/user:tomi with {"user_fqdn":"thebb.com"}
    - fvh/partner:dhl#partner_manager@fvh/user:tomi with {"user_fqdn":"thebb.com"}
    - fvh/partner:dhl#all_partner_user@fvh/user:tomi with {"user_fqdn":"thebb.com"}
    - fvh/partner:dhl#can_create_subfleet@fvh/user:tomi with {"user_fqdn":"thebb.com"}
    - fvh/partner:dhl#approve_vehicle@fvh/user:tomi with {"user_fqdn":"thebb.com"}
    - fvh/partner:dhl#can_create_partner_user@fvh/user:tomi with {"user_fqdn":"thebb.com"}
    - fvh/partner:dhl#can_assign_role_partner_admin@fvh/user:tomi with {"user_fqdn":"thebb.com"}
    - fvh/partner:dhl#manage_subscription@fvh/user:tomi with {"user_fqdn":"thebb.com"}
    - fvh/partner:dhl#view_subscription@fvh/user:tomi with {"user_fqdn":"thebb.com"}
    - fvh/subfleet:budapest_south#can_view_subfleet@fvh/user:tomi with {"user_fqdn":"thebb.com"}
    - fvh/subfleet:budapest_south#can_create_vehicle_request@fvh/user:tomi with {"user_fqdn":"thebb.com"}
    - fvh/organization:thebb#can_create_platform_user@fvh/user:tomi with {"user_fqdn":"thebb.com"}
    - fvh/organization:thebb#can_create_partner@fvh/user:tomi with {"user_fqdn":"thebb.com"}
    - fvh/organization:thebb#can_assign_role_account_manager@fvh/user:tomi with {"user_fqdn":"thebb.com"}
    - fvh/organization:thebb#can_assign_role_platform_admin@fvh/user:tomi with {"user_fqdn":"thebb.com"}
    - fvh/organization:thebb#can_assign_role_platform_support@fvh/user:tomi with {"user_fqdn":"thebb.com"}
    - fvh/organization:thebb#can_revoke_role_account_manager@fvh/user:tomi with {"user_fqdn":"thebb.com"}
    - fvh/organization:thebb#can_revoke_role_platform_admin@fvh/user:tomi with {"user_fqdn":"thebb.com"}
    - fvh/organization:thebb#can_revoke_role_platform_support@fvh/user:tomi with {"user_fqdn":"thebb.com"}
    - fvh/organization:thebb#can_view_performance@fvh/user:tomi with {"user_fqdn":"thebb.com"}
    - fvh/partner:dhl#partner_manager@fvh/user:tomi with {"user_fqdn":"thebb.com"}
    - fvh/partner:dhl#all_partner_user@fvh/user:tomi with {"user_fqdn":"thebb.com"}
    - fvh/partner:dhl#synthetic_relation_platform_admin@fvh/user:tomi with {"user_fqdn":"thebb.com"}
    - fvh/partner:dhl#can_view_partner@fvh/user:tomi with {"user_fqdn":"thebb.com"}
    - fvh/partner:dhl#can_create_partner_user@fvh/user:tomi with {"user_fqdn":"thebb.com"}
    - fvh/partner:dhl#can_manage_user@fvh/user:tomi with {"user_fqdn":"thebb.com"}
    - fvh/partner:dhl#can_deassociate_user_from_partner@fvh/user:tomi with {"user_fqdn":"thebb.com"}
    - fvh/partner:dhl#can_edit_partner_metadata@fvh/user:tomi with {"user_fqdn":"thebb.com"}
    - fvh/partner:dhl#can_associate_subscription@fvh/user:tomi with {"user_fqdn":"thebb.com"}
    - fvh/partner:dhl#can_manage_subscription@fvh/user:tomi with {"user_fqdn":"thebb.com"}
    - fvh/partner:dhl#can_view_subscription@fvh/user:tomi with {"user_fqdn":"thebb.com"}
    - fvh/partner:dhl#can_assign_role_partner_admin@fvh/user:tomi with {"user_fqdn":"thebb.com"}
    - fvh/partner:dhl#can_assign_role_partner_api_manager@fvh/user:tomi with {"user_fqdn":"thebb.com"}
    - fvh/partner:dhl#can_revoke_role_partner_admin@fvh/user:tomi with {"user_fqdn":"thebb.com"}
    - fvh/partner:dhl#can_revoke_role_partner_api_manager@fvh/user:tomi with {"user_fqdn":"thebb.com"}
    - fvh/partner:dhl#can_create_subfleet@fvh/user:tomi with {"user_fqdn":"thebb.com"}
    - fvh/partner:dhl#can_edit_subfleet_metadata@fvh/user:tomi with {"user_fqdn":"thebb.com"}
    - fvh/partner:dhl#can_list_all_subfleets@fvh/user:tomi with {"user_fqdn":"thebb.com"}
    - fvh/partner:dhl#can_manage_vehicle_request@fvh/user:tomi with {"user_fqdn":"thebb.com"}
    - fvh/partner:dhl#can_list_all_vehicle_request@fvh/user:tomi with {"user_fqdn":"thebb.com"}
    - fvh/partner:dhl#can_remove_subfleet@fvh/user:tomi with {"user_fqdn":"thebb.com"}
    - fvh/partner:dhl#can_deassociate_user_from_subfleet@fvh/user:tomi with {"user_fqdn":"thebb.com"}
    - fvh/partner:dhl#can_deassociate_vehicle_from_subfleet@fvh/user:tomi with {"user_fqdn":"thebb.com"}
    - fvh/partner:dhl#can_remove_vehicle@fvh/user:tomi with {"user_fqdn":"thebb.com"}
    - fvh/partner:dhl#can_list_all_subfleet@fvh/user:tomi with {"user_fqdn":"thebb.com"}
    - fvh/partner:dhl#approve_vehicle@fvh/user:tomi with {"user_fqdn":"thebb.com"}
    - fvh/partner:dhl#can_create_vehicle@fvh/user:tomi with {"user_fqdn":"thebb.com"}
    - fvh/partner:dhl#can_associate_user_to_subfleet@fvh/user:tomi with {"user_fqdn":"thebb.com"}
    - fvh/partner:dhl#can_generate_api_key@fvh/user:tomi with {"user_fqdn":"thebb.com"}
    - fvh/partner:dhl#can_list_all_api_key@fvh/user:tomi with {"user_fqdn":"thebb.com"}
    - fvh/partner:dhl#can_remove_api_key@fvh/user:tomi with {"user_fqdn":"thebb.com"}
    - fvh/partner:dhl#manage_subscription@fvh/user:tomi with {"user_fqdn":"thebb.com"}
    - fvh/partner:dhl#view_subscription@fvh/user:tomi with {"user_fqdn":"thebb.com"}
    - fvh/partner:dhl#can_revoke_subscription@fvh/user:tomi with {"user_fqdn":"thebb.com"}
    - fvh/subfleet:budapest_south#synthetic_relation_platform_admin@fvh/user:tomi with {"user_fqdn":"thebb.com"}
    - fvh/subfleet:budapest_south#can_create_vehicle_deassociation_request@fvh/user:tomi with {"user_fqdn":"thebb.com"}
    - fvh/subfleet:budapest_south#can_remove_note@fvh/user:tomi with {"user_fqdn":"thebb.com"}
    - fvh/subfleet:budapest_south#can_create_vehicle_request@fvh/user:tomi with {"user_fqdn":"thebb.com"}
    - fvh/subfleet:budapest_south#can_view_subfleet@fvh/user:tomi with {"user_fqdn":"thebb.com"}
    - fvh/subfleet:budapest_south#can_order_and_manage_dongle@fvh/user:tomi with {"user_fqdn":"thebb.com"}
    - fvh/subfleet:budapest_south#can_connect_to_oem@fvh/user:tomi with {"user_fqdn":"thebb.com"}
    - fvh/subfleet:budapest_south#can_create_note@fvh/user:tomi with {"user_fqdn":"thebb.com"}
    - fvh/subfleet:siofok#can_view_subfleet@fvh/user:feri
    - fvh/subfleet:siofok#can_create_vehicle_request@fvh/user:feri
    - fvh/partner:dhl#partner_manager@fvh/user:feri
    - fvh/partner:dhl#all_partner_user@fvh/user:feri
    - fvh/partner:dhl#can_create_subfleet@fvh/user:feri
    - fvh/partner:dhl#approve_vehicle@fvh/user:feri
    - fvh/partner:dhl#can_create_partner_user@fvh/user:feri
    - fvh/partner:dhl#can_assign_role_partner_admin@fvh/user:feri
    - fvh/partner:dhl#view_subscription@fvh/user:feri
    - fvh/subfleet:budapest_south#can_view_subfleet@fvh/user:feri
    - fvh/subfleet:budapest_south#can_create_vehicle_request@fvh/user:feri
    - fvh/subfleet:siofok#can_view_subfleet@fvh/user:feri
    - fvh/subfleet:siofok#can_create_vehicle_request@fvh/user:feri
    - fvh/organization:thebb#can_create_partner@fvh/user:ben
    - fvh/partner:dhl#partner_manager@fvh/user:ben
    - fvh/partner:dhl#all_partner_user@fvh/user:ben
    - fvh/partner:dhl#can_create_partner_user@fvh/user:ben
    - fvh/partner:dhl#can_assign_role_partner_admin@fvh/user:ben
    - fvh/partner:dhl#manage_subscription@fvh/user:ben
    - fvh/partner:dhl#view_subscription@fvh/user:ben
    - fvh/product:dashboard#can_access@fvh/user:tomi with {"user_fqdn":"thebb.com"}
    - fvh/product:dashboard#can_access@fvh/user:marika
    - fvh/product:headless_api#can_access@fvh/user:adi
    - fvh/product:headless_api#can_access@fvh/user:tomi with {"user_fqdn":"thebb.com"}
    - fvh/subfleet:kispest#can_view_subfleet@fvh/user:bela
    - fvh/subfleet:kispest#can_view_subfleet@fvh/user:neo
  assertFalse:
    - fvh/organization:thebb#can_create_platform_user@fvh/user:feri
    - fvh/organization:thebb#can_create_partner@fvh/user:feri
    - fvh/partner:dhl#manage_subscription@fvh/user:feri
    - fvh/organization:thebb#can_create_platform_user@fvh/user:tomi with {"user_fqdn":"thecc.com"}
    - fvh/organization:thebb#can_create_platform_user@fvh/user:ben
    - fvh/partner:dhl#can_create_subfleet@fvh/user:ben
    - fvh/partner:dhl#approve_vehicle@fvh/user:ben
    - fvh/product:headless_api#can_access@fvh/partner:dhl
    - fvh/product:dashboard#can_access@fvh/partner:fedex
    - fvh/subfleet:budapest_south#can_view_subfleet@fvh/user:ben
    - fvh/subfleet:siofok#can_view_subfleet@fvh/user:ben
    - fvh/subfleet:budapest_south#can_create_vehicle_request@fvh/user:ben
    - fvh/subfleet:siofok#can_create_vehicle_request@fvh/user:ben
    - fvh/subfleet:budapest_south#can_view_subfleet@fvh/user:neo
validation: {}
